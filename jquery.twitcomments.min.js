(function(c){var e={auth:false,pushURL:null,pullURL:null,info:null,form:null,comments:null,intents:false,defaultProfileImageURL:"#",cssClass:"twitcomments",strings:{twitterUsername:"Twitter Username",writeAComment:"Write a comment...",submit:"Comment",from:"from",justNow:"just now",aMinuteAgo:"a minute ago",minutesAgo:"minutes ago",oneHourAgo:"one hour ago",hoursAgo:"hours ago",yesterday:"yesterday",daysAgo:"days ago",aWeekAgo:"a week ago",weeksAgo:"weeks ago",aMonthAgo:"a month ago",monthsAgo:"months ago",aYearAgo:"a year ago",yearsAgo:"years ago"}};var d;var a;var b={init:function(f){c.extend(e,f);d=this;a=e.cssClass+"-";b._setupHTML.apply(this);b._setupEvents.apply(this);b._pullComments.apply(this);return this},_setupHTML:function(){this.addClass(e.cssClass);if(e.info==null){infoBlock=c('<div class="'+a+'info"></div>');infoBlock.hide();d.prepend(infoBlock)}if(null===e.form){action=(e.pushURL===null)?"#":e.pushURL;form=c('<form class="'+a+'form" action="'+action+'" method="post"></form>');form.append(c('<span class="'+a+"span "+a+'at-prefix">@</span>'));form.append(c('<input type="text" name="'+a+'screen_name" class="'+a+"input "+a+'input-screen_name" value="'+e.strings.twitterUsername+'" />'));form.append(c('<textarea name="'+a+'comment" class="'+a+"textarea "+a+'input-comment">'+e.strings.writeAComment+"</textarea>"));form.append(c('<input type="submit" name="'+a+'submit" class="'+a+"button "+a+'input-submit" value="'+e.strings.submit+'" />'));this.append(form)}if(null===e.comments){comments=c('<div class="'+a+'comments"></div>');this.append(comments);comments.hide()}return this},_setupEvents:function(){c("."+a+"input-screen_name, ."+a+"input-comment").on("focus.twitcomments",function(){c(this).data("originalValue",c(this).val());c(this).val("")});c("."+a+"input-screen_name, ."+a+"input-comment").on("blur.twitcomments",function(){originalValue=c(this).data("originalValue");if(c(this).val()==""){c(this).val(originalValue)}});c("."+a+"input-screen_name").on("blur.twitcomments",function(){b._updateUserInfo(c(this).val())});if(e.pushURL){c("."+a+"form").on("submit.twitcomments",function(f){b._submit();f.preventDefault()})}return this},_updateUserInfo:function(f){infoBlock=(e.info)?e.info:c("."+a+"info");infoBlock.hide();c.ajax({url:"http://api.twitter.com/1/users/show.json",type:"GET",data:{screen_name:f},dataType:"jsonp",success:function(g){d.data("userExists",true);d.data("screen_name",g.screen_name);d.data("name",g.name);d.data("url",g.url);d.data("location",g.location);d.data("profile_image_url",g.profile_image_url);infoBlock.html(b._getNewUserBlock(g)).fadeIn()},error:function(g,i,h){alert("Can't load user")}});return this},_pullComments:function(){if(e.pullURL){c.ajax({url:e.pullURL,type:"GET",dataType:"json",success:function(f){comments=c("."+a+"comments");c.each(f,function(g,h){comments.append(b._getNewUserBlock(h))});c("."+a+"comments").fadeIn()},status:{400:function(f,h,g){alert("Can't load comments")}}})}return this},_submit:function(){if(c("."+a+"form ."+a+"input-screen_name").val()==""||c("."+a+"form ."+a+"input-screen_name").val()==e.strings.twitterUsername){alert("User empty")}else{if(!d.data("userExists")){alert("User no exist")}else{if(c("."+a+"form ."+a+"input-comment").val()==""||c("."+a+"form ."+a+"input-comment").val()==e.strings.writeAComment){alert("Comment no")}else{c.ajax({url:e.pushURL,type:"POST",data:{screen_name:d.data("screen_name"),name:d.data("name"),url:d.data("url"),location:d.data("location"),profile_image_url:d.data("profile_image_url"),comment_content:c("."+a+"form ."+a+"input-comment").val()},dataType:"json",success:function(f){infoBlock=b._getNewUserBlock(f[0]).hide();c("."+a+"comments").prepend(infoBlock);infoBlock.fadeIn()},error:function(f,h,g){alert("Can't save")}})}}}},_getNewUserBlock:function(f){imageURL=(f.profile_image_url)?f.profile_image_url:e.defaultProfileImageURL;fullName=(f.url)?'<a href="'+f.url+'">'+f.name+"</a>":f.name;twitterURL=(e.intents)?"https://twitter.com/intent/user?screen_name="+f.screen_name:"http://twitter.com/"+f.screen_name;block=c("<div></div>");block.append(c('<img src="'+imageURL+'" alt="" class="'+a+'user-image" />'));if(f.name){block.append(c('<span class="'+a+"span "+a+'user-name">'+fullName+"</span>"))}block.append(c('<span class="'+a+"span "+a+'user-screen_name"><a href="'+twitterURL+'">@'+f.screen_name+"</a></span>"));if(f.comment_timestamp){block.append(c('<span class="'+a+"span "+a+'comment-time">'+b._relativeDate(new Date(f.comment_timestamp),new Date())+"</span>"))}if(f.location){block.append(c('<span class="'+a+"span "+a+'user-location">'+e.strings.from+" "+f.location+"</span>"))}if(f.comment_content){block.append(c('<span class="'+a+"span "+a+'comment-content">'+f.comment_content+"</span>"))}return block},_relativeDate:function(r,m){var g=1000,h=60*g,j=60*h,l=24*j,f=7*l,p=l*365,k=p/12;var q=[[0.7*h,e.strings.justNow],[1.5*h,e.strings.aMinuteAgo],[60*h,e.strings.minutesAgo,h],[1.5*j,e.strings.oneHourAgo],[l,e.strings.hoursAgo,j],[2*l,e.strings.yesterday],[7*l,e.strings.daysAgo,l],[1.5*f,e.strings.aWeekAgo],[k,e.strings.weeksAgo,f],[1.5*k,e.strings.aMonthAgo],[p,e.strings.monthsAgo,k],[1.5*p,e.strings.aYearAgo],[Number.MAX_VALUE,e.strings.yearsAgo,p]];!m&&(m=(new Date).getTime());m instanceof Date&&(m=m.getTime());r instanceof Date&&(r=r.getTime());var t=m-r,s,n,o;for(n=-1,o=q.length;++n<o;){s=q[n];if(t<s[0]){return s[2]==undefined?s[1]:Math.round(t/s[2])+" "+s[1]}}}};c.fn.twitComments=function(f){if(b[f]){return b[f].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof f==="object"||!f){return b.init.apply(this,arguments)}else{c.error("Method "+f+" does not exist on jQuery.twitComments")}}}})(jQuery);