(function(d){var f={pushURL:null,pullURL:null,params:null,defaultProfileImageURL:"#",cssClass:"twitcomments",strings:{twitterUsername:"Twitter Username",writeAComment:"Write a comment...",submit:"Comment",sending:"Sending...",from:"from",justNow:"just now",aMinuteAgo:"a minute ago",minutesAgo:"minutes ago",oneHourAgo:"one hour ago",hoursAgo:"hours ago",yesterday:"yesterday",daysAgo:"days ago",aWeekAgo:"a week ago",weeksAgo:"weeks ago",aMonthAgo:"a month ago",monthsAgo:"months ago",aYearAgo:"a year ago",yearsAgo:"years ago"}};var e=null;var b=null;var a=null;var c={init:function(g){d.extend(f,g);e=this;b=f.cssClass+"-";this.addClass(f.cssClass);this.hide();c._setupCommentForm.apply(this);c._setupUserProfile.apply(this);c._setupCommentList.apply(this);this.fadeIn();return this},_setupCommentForm:function(){action=(f.pushURL)?f.pushURL:"#";form=d('<form class="'+b+'form" action="'+action+'" method="post"></form>');form.append(d('<span class="'+b+"span "+b+'at-prefix">@</span>'));form.append(d('<input type="text" name="'+b+'screen_name" class="'+b+"input "+b+'input-screen_name" value="'+f.strings.twitterUsername+'" />'));form.append(d('<textarea name="'+b+'comment" class="'+b+"textarea "+b+'input-comment">'+f.strings.writeAComment+"</textarea>"));form.append(d('<input type="submit" name="'+b+'submit" class="'+b+"button "+b+'input-submit" value="'+f.strings.submit+'" />'));this.append(form);form.on("submit.twitcomments",function(g){g.preventDefault();commentContent=d("."+b+"input-comment").val();if(a==null){alert("no user");return false}else{if(commentContent==""||commentContent==f.strings.writeAComment){alert("Comment no");return false}else{c._pushComment()}}});d("."+b+"input-screen_name, ."+b+"input-comment").on("focus.twitcomments",function(){d(this).data("originalValue",d(this).val());d(this).val("")});d("."+b+"input-screen_name, ."+b+"input-comment").on("blur.twitcomments",function(){originalValue=d(this).data("originalValue");if(d(this).val()==""){d(this).val(originalValue)}})},_setupUserProfile:function(){userProfile=d('<div class="'+b+'userProfile"></div>');userProfile.hide();this.prepend(userProfile);var g=0;d("."+b+"input-screen_name").on("keyup.twitcomments",function(){screen_name=d("."+b+"input-screen_name").val();if(g){clearTimeout(g)}g=setTimeout(function(){c._loadUserProfile(screen_name,c._displayUserProfile)},500)})},_setupCommentList:function(){var g=d('<div class="'+b+'comments"></div>');this.append(g);d.ajax({url:f.pullURL,type:"GET",data:{params:f.params},dataType:"json",success:function(h){d.each(h,function(i,j){g.append(c._getCommentPostDOM(j))})},status:{400:function(h,j,i){alert("Can't load comments")}}})},_displayUserProfile:function(){userProfile=d("."+b+"userProfile");if(a!=null&&e.data("user-changed")){userProfile.html(c._getUserProfileDOM(a)).fadeIn()}},_loadUserProfile:function(h,i){var g=d("."+b+"info");g.hide();d.ajax({url:"http://api.twitter.com/1/users/show.json",type:"GET",data:{screen_name:h},dataType:"jsonp",success:function(j){e.data("user-changed",(a==null||(a!=null&&a.screen_name!=j.screen_name)));a={};a.screen_name=j.screen_name;a.name=j.name;a.url=j.url;a.location=j.location;a.profile_image_url=j.profile_image_url;g.html(c._getUserProfileDOM(a)).fadeIn()},error:function(j,l,k){a=null;alert("Can't load user")},complete:function(){i.call()}});return this},_pushComment:function(){c._toggleIndicator();d.ajax({url:f.pushURL,type:"POST",data:{user:a,comment:d("."+b+"form ."+b+"input-comment").val(),params:f.params},dataType:"json",success:function(g){commentBlock=c._getCommentPostDOM(g).hide();d("."+b+"comments").prepend(commentBlock);commentBlock.fadeIn()},error:function(g,i,h){alert("Can't save")},complete:function(){c._toggleIndicator()}})},_toggleIndicator:function(){submitButton=d("."+b+"input-submit");if(submitButton.attr("disabled")=="disabled"){submitButton.val(submitButton.data("original-text"));submitButton.removeAttr("disabled")}else{submitButton.data("original-text",submitButton.val());submitButton.val(f.strings.sending);submitButton.attr("disabled","disabled")}},_getUserProfileDOM:function(g){imageURL=(g.profile_image_url)?g.profile_image_url:f.defaultProfileImageURL;fullName=(g.url)?'<a href="'+g.url+'">'+g.name+"</a>":g.name;userProfile=d("<div></div>");userProfile.append(d('<img src="'+imageURL+'" alt="" class="'+b+'user-image" />'));if(g.name){userProfile.append(d('<span class="'+b+"span "+b+'user-name">'+fullName+"</span>"))}userProfile.append(d('<span class="'+b+"span "+b+'user-screen_name"><a href="http://twitter.com/'+g.screen_name+'">@'+g.screen_name+"</a></span>"));if(g.location){userProfile.append(d('<span class="'+b+"span "+b+'user-location">'+f.strings.from+" "+g.location+"</span>"))}return userProfile},_getCommentPostDOM:function(g){commentBlock=c._getUserProfileDOM(g);commentBlock.append(d('<span class="'+b+"span ."+b+'comment-time">'+c._relativeDate(new Date(g.comment_timestamp),new Date())+"</span>"));commentBlock.append(d('<span class="'+b+"span ."+b+'comment-content">'+g.comment_content+"</span>"));return commentBlock},_relativeDate:function(s,n){var h=1000,j=60*h,k=60*j,m=24*k,g=7*m,q=m*365,l=q/12;var r=[[0.7*j,f.strings.justNow],[1.5*j,f.strings.aMinuteAgo],[60*j,f.strings.minutesAgo,j],[1.5*k,f.strings.oneHourAgo],[m,f.strings.hoursAgo,k],[2*m,f.strings.yesterday],[7*m,f.strings.daysAgo,m],[1.5*g,f.strings.aWeekAgo],[l,f.strings.weeksAgo,g],[1.5*l,f.strings.aMonthAgo],[q,f.strings.monthsAgo,l],[1.5*q,f.strings.aYearAgo],[Number.MAX_VALUE,f.strings.yearsAgo,q]];!n&&(n=(new Date).getTime());n instanceof Date&&(n=n.getTime());s instanceof Date&&(s=s.getTime());var u=n-s,t,o,p;for(o=-1,p=r.length;++o<p;){t=r[o];if(u<t[0]){return t[2]==undefined?t[1]:Math.round(u/t[2])+" "+t[1]}}}};d.fn.twitComments=function(g){if(c[g]){return c[g].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof g==="object"||!g){return c.init.apply(this,arguments)}else{d.error("Method "+g+" does not exist on jQuery.twitComments")}}}})(jQuery);